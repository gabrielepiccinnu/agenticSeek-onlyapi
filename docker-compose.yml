services:
  redis:
    image: docker.io/valkey/valkey:8-alpine
    container_name: agenticseek-redis
    restart: unless-stopped
    command: valkey-server --save 30 1 --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - agenticseek-net
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    logging:
      driver: json-file
      options:
        max-size: "1m"
        max-file: "1"

  searxng:
    image: docker.io/searxng/searxng:latest
    container_name: agenticseek-searxng
    restart: unless-stopped
    volumes:
      - ./searxng:/etc/searxng:rw
    environment:
      SEARXNG_BASE_URL: ${SEARXNG_BASE_URL:-http://searxng:8080/}
      SEARXNG_SECRET_KEY: ${SEARXNG_SECRET_KEY}
      UWSGI_WORKERS: 4
      UWSGI_THREADS: 4
    depends_on:
      - redis
    networks:
      - agenticseek-net
    logging:
      driver: json-file
      options:
        max-size: "1m"
        max-file: "1"

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: agenticseek-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-7777}:7777"
    environment:
      BACKEND_PORT: 7777
      SEARXNG_BASE_URL: http://searxng:8080
      REDIS_BASE_URL: redis://redis:6379/0
      WORK_DIR: /opt/workspace

      OPENAI_API_KEY: ${OPENAI_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      TOGETHER_API_KEY: ${TOGETHER_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      HUGGINGFACE_API_KEY: ${HUGGINGFACE_API_KEY}

    command: python3 api.py
    depends_on:
      - searxng
    networks:
      - agenticseek-net
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: json-file
      options:
        max-size: "2m"
        max-file: "2"

  frontend:
  build:
    context: ./frontend/agentic-seek-front
    dockerfile: Dockerfile.frontend
    container_name: agenticseek-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      REACT_APP_BACKEND_URL: http://agenticseek-backend:7777
    depends_on:
      - backend
    networks:
      - agenticseek-net
    logging:
      driver: json-file
      options:
        max-size: "1m"
        max-file: "1"

volumes:
  redis-data:

networks:
  agenticseek-net:
    driver: bridge
